# 99.绘制轨迹.105
## <a name="index"></a> 目录
- [引子](#start)
- [绘制轨迹](#tail)
- [绘制风粒子](#particles)
  - [颜色数据](#color)

- [参考资料](#reference)

## <a name="start"></a> 引子
了解[绘制粒子][url-pre]之后，接着去看如何绘制粒子轨迹。

- 源库：[webgl-wind][url-1]

## <a name="tail"></a> 绘制轨迹
在原文中提到绘制轨迹的方法是将粒子绘制到纹理中，然后在下一帧上使用该纹理作为背景（稍微变暗），并每一帧交换输入/目标纹理。感觉好像是这么回事，但具体去看代码的时候就是另外一回事。

不包含随机生成的粒子轨迹效果见[示例][url-example-1]。

基于[绘制粒子][url-pre]的基础上，增加逻辑的主要思路：
- 初始化时，除了绘制粒子着色器程序对象，还增加了屏幕着色器程序对象和更新着色器程序对象，还创建了背景纹理 B 和屏幕纹理 S 。
- 创建每个粒子相关信息的数据时，存了两个纹理 T20 和 T21 中。
- 绘制时，先绘制背景纹理 B ，再绘制粒子，接着绘制屏幕纹理 S，之后将屏幕纹理 S 覆盖背景纹理 B 作为下一帧的背景纹理。
- 最后更新粒子，替换当前粒子的状态纹理，下一帧绘制的时候就是最新的状态。

下面就看看具体的实现。

## <a name="new"></a> 新增顶点和纹理
顶点相关逻辑：
```js
// 代码省略
  this.quadBuffer = util.createBuffer(gl, new Float32Array([0, 0, 1, 0, 0, 1, 0, 1, 1, 0, 1, 1]));
// 代码省略
  util.bindAttribute(gl, this.quadBuffer, program.a_pos, 2);
// 代码省略
  gl.drawArrays(gl.TRIANGLES, 0, 6);
// 代码省略
```
这里可以看出以顶点数据按照二维解析，总共 6 个点，绘制的是一个矩形，由于会涉及纹理，这里坐标范围都是 0-1 。

纹理相关逻辑：
```js
// 代码省略
resize() {
  const gl = this.gl;
  const emptyPixels = new Uint8Array(gl.canvas.width * gl.canvas.height * 4);
  // screen textures to hold the drawn screen for the previous and the current frame
  this.backgroundTexture = util.createTexture(gl, gl.NEAREST, emptyPixels, gl.canvas.width, gl.canvas.height);
  this.screenTexture = util.createTexture(gl, gl.NEAREST, emptyPixels, gl.canvas.width, gl.canvas.height);
}
// 代码省略
```
初始化的背景纹理和屏幕纹理都是以 Canvas 的宽高作为标准，同样是以每个像素 4 个分量作为存储大小。

## 新增顶点着色器
```c
precision mediump float;

attribute vec2 a_pos;

varying vec2 v_tex_pos;

void main() {
    v_tex_pos = a_pos;
    gl_Position = vec4(1.0 - 2.0 * a_pos, 0, 1);
}

```

## 绘制屏幕

## 更新粒子

<div align="right"><a href="#index">Back to top :arrow_up:</a></div>

## <a name="reference"></a> 参考资料
- [How I built a wind map with WebGL][url-base]

[url-pre]:https://github.com/XXHolic/blog/issues/104
[url-base]:https://github.com/XXHolic/blog/issues/101

[url-1]:https://github.com/mapbox/webgl-wind
[url-2]:https://community.khronos.org/t/question-about-texture-using-glsl/55658

[url-example-1]:https://xxholic.github.io/lab/blog/98/map.html
[url-example-2]:https://xxholic.github.io/lab/blog/98/particles.html


[url-local-1]:./images/97/1.jpg

<details>
<summary>:wastebasket:</summary>


![97-poster][url-local-poster]

</details>

[url-book]:https://movie.douban.com/subject/34605404/
[url-local-poster]:./images/97/poster.png
