# 98.绘制粒子.104
## <a name="index"></a> 目录
- [引子](#start)
- [安装 ecCodes](#ecCodes)
- [执行脚本](#run)
- [数据生成](#data)
- [数据含义](#mean)
- [参考资料](#reference)

## <a name="start"></a> 引子
了解[风场数据][url-pre]之后，接着去看如何绘制粒子，试着单独剥离相关的逻辑。

- 源库：[webgl-wind][url-1]

## <a name="map"></a> 绘制地图粒子
查看源库，发现单独有一个 Canvas 绘制地图，首先是获取世界地图海岸线坐标，主要格式如下：
```json
{
  "type": "FeatureCollection",
  "features": [
    {
      "type": "Feature",
      "properties": {
        "scalerank": 1,
        "featureclass": "Coastline"
      },
      "geometry": {
        "type": "LineString",
        "coordinates": [
          [
              -163.7128956777287,
              -78.59566741324154
          ],
          // 数据省略
        ]
      }
    },
    // 数据省略
  ]
}
```
这些坐标直接连接起来就可以形成整体的轮廓，但需要跟风场数据对应起来，映射主要逻辑如下：
```js
  // 省略
  for (let i = 0; i < len; i++) {
    const coordinates = data[i].geometry.coordinates || [];
    const coordinatesNum = coordinates.length;
    for (let j = 0; j < coordinatesNum; j++) {
      context[j ? "lineTo" : "moveTo"](
        ((coordinates[j][0] + 180) * node.width) / 360,
        ((-coordinates[j][1] + 90) * node.height) / 180
      );
  }
  // 省略
```
按照 Canvas 实际的宽高度，与生成的风场图片宽高按比例映射。

绘制地图的单独逻辑见[示例][url-example-1]。

## <a name="particles"></a> 绘制风粒子
查看源库，单独有一个 Canvas 绘制风粒子。刚开始看源码的时候，发现其中的逻辑一下子涉及到太多，于是先单独弄明白绘制静态粒子的逻辑。

绘制风粒子的单独逻辑见[示例][url-example-2]。

先理一下实现的主要思路：
- 风速映射到像素颜色编码的 R 和 G 分量，由此生成了图片 W 。
- 根据使用的分量创建颜色数据，存放到纹理 T1 中。
- 根据粒子数，创建存储粒子索引的数据并缓冲。还创建每个粒子相关信息的数据，并存放到纹理 T2 中。
- 加载图片 W 并将图片数据存放到纹理 T3 中。
- 顶点着色器处理的时候，会根据粒子索引从纹理 T2 中获取对应数据，根据这个会生成一个位置 P 传递给片元着色器。
- 片元着色器根据位置 P 从图片纹理 T3 中得到数据并进行线性混合得到一个值 N ，根据 N 在颜色纹理 T1 中得到对应的颜色。

下面就看看具体的实现。

### 颜色数据
生成颜色数据主要逻辑：
```js
function getColorRamp(colors) {
  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");

  canvas.width = 256;
  canvas.height = 1;
  // createLinearGradient 用法： https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/createLinearGradient
  const gradient = ctx.createLinearGradient(0, 0, 256, 0);
  for (const stop in colors) {
    gradient.addColorStop(+stop, colors[stop]);
  }

  ctx.fillStyle = gradient;
  ctx.fillRect(0, 0, 256, 1);

  return new Uint8Array(ctx.getImageData(0, 0, 256, 1).data);
}
```
这里通过创建一个渐变的 Canvas 得到数据，由于跟颜色要对应，一个颜色分量存储为 8 位二进制，总共 256 种。

但在创建纹理的时候，为什么要指定纹理的宽高度为 16 ？
```js
this.colorRampTexture = util.createTexture(
  this.gl,
  this.gl.LINEAR,
  getColorRamp(colors),
  16,
  16
);
```

### 顶点数据和状态数据
主要逻辑：
```js
  set numParticles(numParticles) {
    const gl = this.gl;

    const particleRes = (this.particleStateResolution = Math.ceil(
      Math.sqrt(numParticles)
    ));
    this._numParticles = particleRes * particleRes;

    const particleState = new Uint8Array(this._numParticles * 4);
    for (let i = 0; i < particleState.length; i++) {
      particleState[i] = Math.floor(Math.random() * 256);
    }
    this.particleStateTexture = util.createTexture(
      gl,
      gl.NEAREST,
      particleState,
      particleRes,
      particleRes
    );
    const particleIndices = new Float32Array(this._numParticles);
    for (let i = 0; i < this._numParticles; i++) particleIndices[i] = i;
    this.particleIndexBuffer = util.createBuffer(gl, particleIndices);
  }
```



### 顶点着色器

### 片段着色器

### 绘制

首先看下初始化 WebGL 上下文逻辑：
```js
  const wind = new WindGL(gl);
  wind.numParticles = 65536;
```
针对风场数据处理写了一个 `WindGL` 类，该类初始化的逻辑


<div align="right"><a href="#index">Back to top :arrow_up:</a></div>

## <a name="reference"></a> 参考资料
- [How I built a wind map with WebGL][url-base]

[url-pre]:https://github.com/XXHolic/blog/issues/103
[url-base]:https://github.com/XXHolic/blog/issues/101
[url-1]:https://github.com/mapbox/webgl-wind


[url-2]:https://github.com/fxcoudert/gfortran-for-macOS/releases
[url-3]:https://gcc.gnu.org/wiki/GFortranBinaries
[url-4]:https://www.jianshu.com/p/407f0f9d8203
[url-5]:https://github.com/ecmwf/eccodes
[url-6]:https://www.cnblogs.com/shineqiujuan/p/4693404.html
[url-7]:https://github.com/mapbox/webgl-wind/issues/15
[url-8]:https://github.com/mapbox/webgl-wind/pull/18
[url-9]:https://github.com/XXHolic/webgl-wind
[url-10]:http://colaweb.gmu.edu/dev/clim301/lectures/wind/wind-uv
[url-11]:https://github.com/lukeapage/pngjs

[url-example-1]:https://xxholic.github.io/lab/blog/98/map.html
[url-example-2]:https://xxholic.github.io/lab/blog/98/particles.html


[url-local-1]:./images/97/1.jpg

<details>
<summary>:wastebasket:</summary>

[《JOJO的奇妙冒险 石之海》][url-book] 最近一下子放出了 12 集，质量还是相当好的。

![97-poster][url-local-poster]

</details>

[url-book]:https://movie.douban.com/subject/34605404/
[url-local-poster]:./images/97/poster.png
