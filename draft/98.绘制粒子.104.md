# 98.绘制粒子.104
## <a name="index"></a> 目录
- [引子](#start)
- [安装 ecCodes](#ecCodes)
- [执行脚本](#run)
- [数据生成](#data)
- [数据含义](#mean)
- [参考资料](#reference)

## <a name="start"></a> 引子
了解[风场数据][url-pre]之后，接着去看如何绘制粒子，试着单独剥离相关的逻辑。

- 源库：[webgl-wind][url-1]

## <a name="map"></a> 绘制地图粒子
查看源库，发现单独有一个 Canvas 绘制地图，首先是获取世界地图海岸线坐标，主要格式如下：
```json
{
  "type": "FeatureCollection",
  "features": [
    {
      "type": "Feature",
      "properties": {
        "scalerank": 1,
        "featureclass": "Coastline"
      },
      "geometry": {
        "type": "LineString",
        "coordinates": [
          [
              -163.7128956777287,
              -78.59566741324154
          ],
          // 数据省略
        ]
      }
    },
    // 数据省略
  ]
}
```
这些坐标直接连接起来就可以形成整体的轮廓，但需要跟风场数据对应起来，映射主要逻辑如下：
```js
  // 省略
  for (let i = 0; i < len; i++) {
    const coordinates = data[i].geometry.coordinates || [];
    const coordinatesNum = coordinates.length;
    for (let j = 0; j < coordinatesNum; j++) {
      context[j ? "lineTo" : "moveTo"](
        ((coordinates[j][0] + 180) * node.width) / 360,
        ((-coordinates[j][1] + 90) * node.height) / 180
      );
  }
  // 省略
```
按照 Canvas 实际的宽高度，与生成的风场图片宽高按比例映射。

绘制地图的单独逻辑见[示例][url-example-1]。

## <a name="particles"></a> 绘制风粒子
查看源库，单独有一个 Canvas 绘制风粒子。刚开始看源码的时候，发现其中的逻辑一下子涉及到太多，于是先单独弄明白绘制静态粒子的逻辑。

绘制风粒子的单独逻辑见[示例][url-example-2]。

先理一下实现的主要逻辑：
- 风速映射到像素颜色编码的 R 和 G 分量，由此生成了图片 W 。
- 根据使用的分量创建显示的颜色纹理 C 。
- 根据粒子数，创建存储粒子索引的数据并缓冲。还创建存储每个粒子 rgba 信息的数据，存放到纹理 a 中。
- 加载图片 W 并将图片数据存放到纹理 b 中。
- 顶点着色器处理的时候，会根据粒子索引从纹理 a 中获取对应的 rgba 信息，根据这个信息会生成一个位置信息 P 传递给片元着色器。
- 片元着色器根据位置信息 P 从纹理 b 中得到 rgba 信息并进行线性混合得到一个新值 N ，根据 N 在颜色纹理 C 中得到对应的颜色。

下面就看看具体的实现。

### 颜色纹理


### 顶点着色器

### 片段着色器

### 绘制

首先看下初始化 WebGL 上下文逻辑：
```js
  const wind = new WindGL(gl);
  wind.numParticles = 65536;
```
针对风场数据处理写了一个 `WindGL` 类，该类初始化的逻辑


<div align="right"><a href="#index">Back to top :arrow_up:</a></div>

## <a name="reference"></a> 参考资料
- [How I built a wind map with WebGL][url-base]

[url-pre]:https://github.com/XXHolic/blog/issues/103
[url-base]:https://github.com/XXHolic/blog/issues/101
[url-1]:https://github.com/mapbox/webgl-wind


[url-2]:https://github.com/fxcoudert/gfortran-for-macOS/releases
[url-3]:https://gcc.gnu.org/wiki/GFortranBinaries
[url-4]:https://www.jianshu.com/p/407f0f9d8203
[url-5]:https://github.com/ecmwf/eccodes
[url-6]:https://www.cnblogs.com/shineqiujuan/p/4693404.html
[url-7]:https://github.com/mapbox/webgl-wind/issues/15
[url-8]:https://github.com/mapbox/webgl-wind/pull/18
[url-9]:https://github.com/XXHolic/webgl-wind
[url-10]:http://colaweb.gmu.edu/dev/clim301/lectures/wind/wind-uv
[url-11]:https://github.com/lukeapage/pngjs

[url-example-1]:https://xxholic.github.io/lab/blog/98/map.html
[url-example-2]:https://xxholic.github.io/lab/blog/98/particles.html


[url-local-1]:./images/97/1.jpg

<details>
<summary>:wastebasket:</summary>

[《JOJO的奇妙冒险 石之海》][url-book] 最近一下子放出了 12 集，质量还是相当好的。

![97-poster][url-local-poster]

</details>

[url-book]:https://movie.douban.com/subject/34605404/
[url-local-poster]:./images/97/poster.png
